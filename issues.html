<html>
  <head>
    <meta charset="UTF-8">
    <title>Issues</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="main.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js" charset="utf-8"></script>
    <script type="module">
      import { Octokit } from "https://cdn.skypack.dev/@octokit/core";
      const octokit = new Octokit();

      const getKey = date => {
        const time = new Date(date).getTime();
        const key = Math.floor(time / (7 * 24 * 60 * 60 * 1000));
        return key;
      }

      const key2week = key => {
        const time = key * (7 * 24 * 60 * 60 * 1000);
        const date = new Date(time);
        return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
      }

      const getBatched = (arr, prop) => arr.reduce((res, e) => {
        if (e[prop]) {
          const key = getKey(e[prop]);
          if (res[key] === undefined) {
            res[key] = [];
          }
          res[key].push(e);
        }
        return res;
      }, {});

      // fetch all issues from github
      const fetchIssues = async (org, proj) => {
        let issues = [];
        for (let i = 1; i < 100; i++) {
          const resp = await octokit.request('GET /repos/' + org + '/' + proj + '/issues', {
            state: 'all',
            per_page: 100,
            page: i
          });
          if (resp.status !== 200) {
            return;
          }
          const issuesPage = resp.data;
          console.log('page: ' + i + ', issues: ' + issuesPage.length);
          issues = issues.concat(issuesPage);
          if (issuesPage.length < 100) {
            break;
          }
        }
        // console.log(issues.map(e => e.milestone  && e.milestone.title));
        return issues;
      };

      const plotIssues = async (rootDiv, issues, title) => {
        let dMin = 99999;
        let dMax = 0

        const createdPerWeek = getBatched(issues, 'created_at');
        const plotData1 = Object.keys(createdPerWeek).reduce((res, key, len) => {
          dMin = Math.min(dMin, key);
          dMax = Math.max(dMax, key);
          res.x.push(key2week(key));
          res.y.push(createdPerWeek[key].length);
          return res;
        }, {x: [], y: [], type: 'bar', name: 'created'});

        const closedPerWeek = getBatched(issues, 'closed_at');
        const plotData2 = Object.keys(closedPerWeek).reduce((res, key, len) => {
          dMin = Math.min(dMin, key);
          dMax = Math.max(dMax, key);
          res.x.push(key2week(key));
          res.y.push(-closedPerWeek[key].length);
          return res;
        }, {x: [], y: [], type: 'bar', name: 'closed'});

        const totalOpen = {};
        let total = 0;
        for (let key = dMin; key <= dMax; key++) {
          total += createdPerWeek[key] ? createdPerWeek[key].length : 0;
          total -= closedPerWeek[key] ? closedPerWeek[key].length : 0;
          totalOpen[key] = total;
        }
        // console.log(totalOpen);
        const plotData3 = Object.keys(totalOpen).reduce((res, key, len) => {
          res.x.push(key2week(key));
          res.y.push(totalOpen[key]);
          return res;
        }, {x: [], y: [], type: 'line', name: 'total open'});
        // console.log(plotData1, plotData2, plotData3);

        const plotDiv = document.createElement('div');
        rootDiv.append(plotDiv);
        Plotly.plot(plotDiv,
          [plotData1, plotData2, plotData3],
          {
            legend: {x: 0.1},
            title
          }
        );
      }

      const MAIN = async divName => {
        const rootDiv = document.getElementById(divName);
        const issues = await fetchIssues('llvm', 'circt');
        await plotIssues(rootDiv, issues, 'All issues');
        const issuesM1 = issues.filter(e => e.milestone && (e.milestone.title === 'SiFive-1'));
        await plotIssues(rootDiv, issuesM1, 'SiFive-1');
        const issuesM2 = issues.filter(e => e.milestone && (e.milestone.title === 'SiFive-2'));
        await plotIssues(rootDiv, issuesM2, 'SiFive-2');
      };
      MAIN('view42');
    </script>
  </head>
  <body>
    <h1>CIRCT Issues Weekly</h1>
    <div class="container" id="view42"></div>
    For more details: <a href="https://github.com/llvm/circt/issues">https://github.com/llvm/circt/issues</a>
  </body>
</html>
